<!DOCTYPE html>
<html>
<head>
    <title>Trading Terminal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; height: 100vh; margin: 0; background: #000; color: #ccc; display: flex; }
        #sidebar { width: 300px; background: #161b22; border-right: 1px solid #333; display: flex; flex-direction: column; }
        #main { flex: 1; display: flex; flex-direction: column; position: relative; }
        
        .stock-item { padding: 12px; border-bottom: 1px solid #333; cursor: pointer; display: flex; justify-content: space-between; }
        .stock-item:hover { background: #222; }
        .up { color: #4caf50; } .down { color: #f23645; }
        
        #charts-area { flex: 1; display: flex; flex-direction: column; }
        #price-chart { flex: 2; border-bottom: 1px solid #333; }
        #rsi-chart { flex: 1; max-height: 150px; }
        
        .panel { padding: 15px; background: #161b22; display: flex; gap: 10px; align-items: center; }
        input, select { padding: 8px; background: #0d1117; border: 1px solid #333; color: white; }
        button { padding: 8px 20px; border: none; font-weight: bold; cursor: pointer; }
        .buy { background: #238636; color: white; } .sell { background: #da3633; color: white; }
        
        #overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 99; flex-direction: column; }
        .hidden { display: none !important; }
        h1 { color: white; }
    </style>
</head>
<body>

<div id="overlay">
    <h1 id="status-text">Connecting...</h1>
    <p>Waiting for Organizer to Start</p>
</div>

<div id="sidebar">
    <div style="padding:15px; font-weight:bold; color:white;">MARKET WATCH</div>
    <div id="stocks" style="flex:1; overflow-y:auto;"></div>
    <div style="padding:15px; border-top:1px solid #333;">
        <div>PORTFOLIO</div>
        <div style="font-size:20px; color:white;">₹ <span id="val">0</span></div>
        <div style="font-size:12px; margin-top:5px;">Cash: ₹<span id="cash">0</span></div>
        <div id="positions" style="font-size:12px; margin-top:10px;"></div>
    </div>
</div>

<div id="main">
    <div style="padding:10px; background:#161b22; color:white; display:flex; justify-content:space-between;">
        <span id="current-stock">SELECT STOCK</span>
        <span>DAY: <span id="day">1</span>/12</span>
    </div>
    
    <div id="charts-area">
        <div id="price-chart"></div>
        <div id="rsi-chart"></div>
    </div>
    
    <div class="panel">
        <select id="otype" onchange="toggleSL()">
            <option value="market">Market Order</option>
            <option value="stop_loss_sell">Stop Loss (Sell)</option>
            <option value="stop_loss_buy">Stop Loss (Buy)</option>
        </select>
        <input type="number" id="qty" placeholder="Qty" value="50" style="width:60px;">
        <input type="number" id="trig" placeholder="Trigger Price" style="display:none; width:80px;">
        
        <button class="buy" onclick="trade('buy')">BUY</button>
        <button class="sell" onclick="trade('sell')">SELL</button>
        <span id="msg" style="margin-left:auto;"></span>
    </div>
</div>

<script>
    const socket = io();
    const params = new URLSearchParams(window.location.search);
    let username = params.get('username') || "Guest";
    let currentSym = "";
    let candleData = {}; // { RELIANCE: [{time, open...}, ...], ... }
    
    // --- CHARTS ---
    const chart = LightweightCharts.createChart(document.getElementById('price-chart'), {
        layout: { background: { type: 'solid', color: '#0d1117' }, textColor: '#ccc' },
        grid: { vertLines: { color: '#222' }, horzLines: { color: '#222' } },
        timeScale: { timeVisible: true, secondsVisible: true }
    });
    const candleSeries = chart.addCandlestickSeries();
    
    const rsiChart = LightweightCharts.createChart(document.getElementById('rsi-chart'), {
        layout: { background: { type: 'solid', color: '#0d1117' }, textColor: '#ccc' },
        grid: { vertLines: { color: '#222' }, horzLines: { color: '#222' } },
        timeScale: { visible: false }
    });
    const rsiSeries = rsiChart.addLineSeries({ color: '#2962ff', lineWidth: 1 });
    const rsiBase = rsiChart.addLineSeries({ color: 'white', lineWidth: 1, lineStyle: 2 }); // 70/30 lines logic can be added

    // --- LOGIC ---
    socket.emit('join_game', {username: username});

    socket.on('game_status', (d) => {
        document.getElementById('day').innerText = d.day;
        let ov = document.getElementById('overlay');
        let txt = document.getElementById('status-text');
        
        if(d.status === 'lobby') { ov.classList.remove('hidden'); txt.innerText = "LOBBY - WAITING"; }
        else if(d.status === 'active') { ov.classList.add('hidden'); }
        else if(d.status === 'paused') { ov.classList.remove('hidden'); txt.innerText = "GAME PAUSED"; }
        else if(d.status === 'ended') { ov.classList.remove('hidden'); txt.innerText = "GAME OVER"; }
    });
    
    socket.on('game_over', (d) => {
        document.getElementById('status-text').innerHTML = `WINNER: ${d.winner}<br>Returns: ₹${d.return}`;
    });

    socket.on('init_data', (d) => {
        let html = "";
        for(let s in d.stocks) {
            html += `<div class="stock-item" onclick="loadStock('${s}')">
                <span>${s}</span><span id="p-${s}">${d.stocks[s].price}</span>
            </div>`;
            candleData[s] = d.stocks[s].history || [];
        }
        document.getElementById('stocks').innerHTML = html;
        updatePort(d.portfolio, d.stocks);
    });

    socket.on('price_tick', (prices) => {
        for(let s in prices) {
            let el = document.getElementById(`p-${s}`);
            if(el) {
                let old = parseFloat(el.innerText);
                el.innerText = prices[s].toFixed(2);
                el.className = prices[s] >= old ? "up" : "down";
            }
            // Update Live Candle on Chart
            if(s === currentSym && candleData[s].length > 0) {
                let last = {...candleData[s][candleData[s].length-1]};
                // Fake the update for smooth visual
                last.close = prices[s];
                last.high = Math.max(last.high, prices[s]);
                last.low = Math.min(last.low, prices[s]);
                candleSeries.update(last);
            }
        }
    });

    socket.on('candle_close', (d) => {
        if(!candleData[d.symbol]) candleData[d.symbol] = [];
        candleData[d.symbol].push(d.candle);
        
        if(d.symbol === currentSym) {
            candleSeries.update(d.candle);
            rsiSeries.update({ time: d.candle.time, value: d.candle.rsi });
        }
    });

    socket.on('portfolio_update', (p) => updatePort(p));
    socket.on('order_result', (r) => {
        document.getElementById('msg').innerText = r.msg;
        setTimeout(() => document.getElementById('msg').innerText = "", 3000);
    });
    socket.on('notification', (d) => { if(d.username === username) alert(d.msg); });

    function loadStock(sym) {
        currentSym = sym;
        document.getElementById('current-stock').innerText = sym;
        candleSeries.setData(candleData[sym]);
        
        // RSI Data
        let rsiData = candleData[sym].map(c => ({ time: c.time, value: c.rsi || 50 }));
        rsiSeries.setData(rsiData);
        
        // Fix Scale
        chart.timeScale().fitContent();
    }

    function trade(side) {
        if(!currentSym) return alert("Select Stock");
        socket.emit('place_order', {
            username: username, symbol: currentSym, side: side,
            qty: document.getElementById('qty').value,
            type: document.getElementById('otype').value,
            trigger: document.getElementById('trig').value
        });
    }

    function updatePort(p, stocks) {
        document.getElementById('cash').innerText = p.cash.toFixed(0);
        let val = p.cash;
        let html = "";
        for(let s in p.holdings) {
            let q = p.holdings[s];
            if(q !== 0) {
                html += `<div>${s}: ${q}</div>`;
                let price = stocks ? stocks[s].price : parseFloat(document.getElementById(`p-${s}`).innerText);
                val += q * price;
            }
        }
        document.getElementById('positions').innerHTML = html;
        document.getElementById('val').innerText = val.toFixed(0);
    }
    
    function toggleSL() {
        let t = document.getElementById('otype').value;
        document.getElementById('trig').style.display = t.includes('stop_loss') ? 'block' : 'none';
    }
    
    // Resize
    window.addEventListener('resize', () => {
        chart.resize(document.getElementById('price-chart').clientWidth, 300);
        rsiChart.resize(document.getElementById('rsi-chart').clientWidth, 150);
    });
</script>
</body>
</html>
